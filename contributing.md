# Contributing to the ssh Linux System Role

## Where to start

The first place to go is [Contribute](https://linux-system-roles.github.io/contribute.html).
This has all of the common information that all role developers need:

* Role structure and layout
* Development tools - How to run tests and checks
* Ansible recommended practices
* Basic git and github information
* How to create git commits and submit pull requests

**Bugs and needed implementations** are listed on
[Github Issues](https://github.com/linux-system-roles/ssh/issues).
Issues labeled with
[**help wanted**](https://github.com/linux-system-roles/ssh/issues?q=is%3Aissue+is%3Aopen+label%3A%22help+wanted%22)
are likely to be suitable for new contributors!

**Code** is managed on [Github](https://github.com/linux-system-roles/ssh), using
[Pull Requests](https://help.github.com/en/github/collaborating-with-issues-and-pull-requests/about-pull-requests).

## Developer documentation for ssh system role

### Internal role variables

These variables are used by the role internals and can be used to override
the defaults that correspond to each supported platform.

* `__ssh_packages`:

Minimal list of packages to install on a given platform for openssh clients
to function. Do not override this variable if you need to install additional
packages. Use `ssh_additional_packages` instead.

* `__ssh_drop_in_template`:

The template for a filename used for global drop-in configuration snippets.
The default value is `/etc/ssh/ssh_config.d/{name}.conf`.

* `__ssh_defaults`:

This variable contains a dict with default configuration options available
in the main system-wide configuration file, usually `/etc/ssh/ssh_config`.

* `__ssh_supports_drop_in`:

The boolean flag describing if the system/openssh on the system supports
drop-in directory and this role should use it instead of overriding the
system-wide configuration file.

* `__ssh_supports_validate`:

The boolean flag which controls whether the system/openssh supports test
mode and the generated configuration file can be checked for syntax before
writing to the file-system. Some older versions (for example openssh 5.3p1)
do not support this and need to skip this check.

### Template Generation

The [`ssh_config.j2`](templates/ssh_config.j2) template is programmatically
generated by the scripts in `.dev-tools`. New options should be added to the
`options_body`.

To regenerate the template, from within the `.dev-tools/` directory run:
`./make_option_list >../templates/ssh_config.j2`

### Testing

To run the tests locally in container, you can use the attached Containerfile
(variation for Debian):

```bash
podman build -t system-roles-ssh .dev-tools
podman run -itv ./:/src:Z system-roles-ssh
```
## Running CI Tests Locally

### Use tox-lsr with qemu

The latest version of tox-lsr supports qemu testing.
<https://github.com/linux-system-roles/tox-lsr#qemu-testing>

**Steps:**

1. If you are using RHEL or CentOS, enable the EPEL repository for your
   platform - <https://docs.fedoraproject.org/en-US/epel/>

2. Use yum or dnf to install `standard-test-roles-inventory-qemu`
   * If for some reason dnf/yum do not work, just download the script from
     <https://pagure.io/standard-test-roles/raw/master/f/inventory/standard-inventory-qcow2> <!--- wokeignore:rule=master -->
     * copy to your `$PATH`, and make sure it is executable

3. Install tox
   * Use yum/dnf to install `python3-tox` - if that does not work, then use
     `pip install --user tox`, then make sure `~/.local/bin` is in your `$PATH`

4. Install tox-lsr <https://github.com/linux-system-roles/tox-lsr#how-to-get-it>

   ```bash
   pip install --user git+https://github.com/linux-system-roles/tox-lsr@main
   ```

5. Download the config file to `~/.config/linux-system-roles.json` from
   <https://github.com/linux-system-roles/linux-system-roles.github.io/blob/main/download/linux-system-roles.json>

6. Assuming you are in a git clone of a role repo which has a tox.ini file -
   you can use e.g.

   ```bash
   tox -e qemu-ansible-core-2.14 -- --image-name centos-9 tests/tests_default.yml
   ```

There are many command line options and environment variables which can be used
to control the behavior, and you can customize the testenv in tox.ini. See
<https://github.com/linux-system-roles/tox-lsr#qemu-testing>

This method supports RHEL also - will download the latest image for a compose,
and will set up the yum repos to point to internal composes.

See <https://linux-system-roles.github.io/contribute.html> for general
development guidelines.
